<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    <link rel="stylesheet" type"text/css" href="./lamp_ctrl.css">
</head>

<body>
    <div>
        <div class = "Table">
            <div class = "TableRow">

                <div class = "TableCell">
                    <div class ="Icon" id = "iconA">
                        <img src = "icon/svg/bulb.svg">
                        A
                    </div>
                </div>

                <div class = "TableCell">
                    <div class ="Icon" id = "iconB">
                        <img src = "icon/svg/bulb.svg">
                        B
                    </div>
                </div>

                <div class = "TableCell">
                    <div class ="Icon" id = "iconC">
                        <img src = "icon/svg/bulb.svg">
                        C
                    </div>
                </div>

            </div>
        </div>
    </div>


    <div id="mode_selector_container" style = "display : none">

        <select id="mode_selector">
            <option value="" selected disabled hidden>Choose mode</option>
            <option value="off">OFF</option>
            <option value="solid_rgb">solid RGB</option>
            <option value="fx_fire">fire</option>
        </select>

        <div id = "rgb_selector_container" style = "display : none">
            <div class = "Table">
                <div class = "TableRow">
                    <div class = "TableCell">
                        <p>R</p>
                        <p>G</p>
                        <p>B</p>
                    </div>
                    <div class = "TableCell">
                        <p><input type="range" min="0" max="255" value="0" class="Slider" id="sliderR"></p>
                        <p><input type="range" min="0" max="255" value="0" class="Slider" id="sliderG"></p>
                        <p><input type="range" min="0" max="255" value="0" class="Slider" id="sliderB"></p>
                    </div>
                    <div class = "TableCell">
                        <canvas id="rgb_canvas" width=100% style="border:1px solid rgb(0,0,0)"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

<script src="lib/socket.io.js"></script>

<script>
    let data =
    [
        {
            "name" : "A",
            "mode" : "",
            "R" : 0, "G" : 0, "B" : 0
        },
        {
            "name" : "B",
            "mode" : "",
            "R" : 0, "G" : 0, "B" : 0
        },
        {
            "name" : "C",
            "mode" : "",
            "R" : 0, "G" : 0, "B" : 0
        }
    ];

    /* whenever Icon is clicked dataIdx is set to valid index into data array */
    let dataIdx = -1;

    function hideOtherIcons(idx)
    {
        for(let i = 0; i < data.length; ++i)
        {
            if(idx != i)
            {
                let otherIcon = document.getElementById("icon" + data[i].name);
                otherIcon.style.display = "none";
            }
        }
    }

    function showOtherIcons(idx)
    {
        for(let i = 0; i < data.length; ++i)
        {
            if(idx != i)
            {
                let otherIcon = document.getElementById("icon" + data[i].name);
                otherIcon.style.display = "inline-block";
            }
        }
    }

    function registerIconOnClick()
    {
        for(let i = 0; i < data.length; ++i)
        {
            let icon = document.getElementById("icon" + data[i].name);

            icon.dataIdx = i;
            icon.onclick =
                function()
                {
                    let container = document.getElementById('mode_selector_container');

                    if("none" === container.style.display)
                    {
                        dataIdx =  this.dataIdx;
                        hideOtherIcons(this.dataIdx);
                        updateModeSelector(this.dataIdx);
                        container.style.display = "block";
                    }
                    else
                    {
                        container.style.display = "none";
                        showOtherIcons(this.dataIdx);
                        dataIdx = -1;
                    }
                }
        }
    }

    function updateCanvas(idx)
    {
        let canvas = document.getElementById("rgb_canvas");
        canvas.getContext('2d').fillStyle = 'rgb(' + data[idx].R + ', ' + data[idx].G + ', ' + data[idx].B +')';
        canvas.getContext('2d').fillRect(0, 0, canvas.width, canvas.height);
    }

    function updateSliders(idx)
    {
        let rSlider = document.getElementById("sliderR");
        let gSlider = document.getElementById("sliderG");
        let bSlider = document.getElementById("sliderB");

        rSlider.valueAsNumber = data[idx].R;
        gSlider.valueAsNumber = data[idx].G;
        bSlider.valueAsNumber = data[idx].B;
    }

    function updateModeSelector(idx)
    {
        let selector = document.getElementById("mode_selector");

        if(selector.value !== data[idx].mode)
        {
            selector.value = data[idx].mode;
        }

        /* solid_rgb */
        {
            let container = document.getElementById('rgb_selector_container');


            if("solid_rgb" === data[idx].mode)
            {
                container.style.display = "block";
                updateCanvas(idx);
                updateSliders(idx);
            }
            else
            {
                container.style.display = "none";
            }
        }
    }

    function emitLampUpdate(idx)
    {
        let socket_io = io("http://localhost:8090");

        let request =
            {
                "id" : data[idx].name,
                "mode" : data[idx].mode,
            };

        if("solid_rgb" == data[idx].mode)
        {
            request.R = data[idx].R;
            request.G = data[idx].G;
            request.B = data[idx].B;

        }

        socket_io.emit("UpdateLamp", request);
    }

    function registerSlidersOnChange()
    {
        let rSlider = document.getElementById("sliderR");
        let gSlider = document.getElementById("sliderG");
        let bSlider = document.getElementById("sliderB");

        rSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].R = this.valueAsNumber;
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });

        gSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].G = this.valueAsNumber;
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });

        bSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].B = this.valueAsNumber;
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });
    }

    function registerModeSelectorOnChange()
    {
        let modeSelector = document.getElementById("mode_selector");

        modeSelector.onchange =
            function()
            {
                data[dataIdx].mode = this.value;
                updateModeSelector(dataIdx);
                emitLampUpdate(dataIdx);
            };
    }

    window.addEventListener(
        "load",
        function()
        {
            registerIconOnClick();
            registerModeSelectorOnChange();
            registerSlidersOnChange();
        });
</script>
</body>
</html>
