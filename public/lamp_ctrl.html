<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    <link rel="stylesheet" type"text/css" href="./lamp_ctrl.css">
</head>

<body>
    <div>
        <div class = "Table">
            <div class = "TableRow">

                <div class = "TableCell">
                    <div class ="Icon" id = "iconA">
                        <img src = "icon/svg/bulb.svg">
                        A
                    </div>
                </div>

                <div class = "TableCell">
                    <div class ="Icon" id = "iconB">
                        <img src = "icon/svg/bulb.svg">
                        B
                    </div>
                </div>

                <div class = "TableCell">
                    <div class ="Icon" id = "iconC">
                        <img src = "icon/svg/bulb.svg">
                        C
                    </div>
                </div>

            </div>
        </div>
    </div>


    <div id="mode_selector_container" style = "display : none">

        <select id="mode_selector">
            <option value="" selected disabled hidden>Choose mode</option>
            <option value="off">OFF</option>
            <option value="solid_rgb">solid RGB</option>
            <option value="fx_fire">fire</option>
            <option value="fx_torch">torch</option>
        </select>

        <div id = "mode_container" style = "display : none">

            <div class = "Table">
                <div class = "TableRow">
                        <div class = "TableCell">
                            <p>BRIGHTNESS</p>
                        </div>
                        <div class = "TableCell">
                            <p><input type="range" min="0" max="255" value="0" id="brightness_slider"></p>
                        </div>
                        <div class = "TableCell">
                            <p id = "brightness_lookup" style = "text-align: right"></p>
                        </div>
                </div>
                <div class = "TableRow">
                    <div class = "TableCell">
                        <p>REFRESH RATE</p>
                        </div>
                        <div class = "TableCell">
                            <p><input type="range" min="4" max="240" value="0" id="fps_slider"></p>
                        </div>
                        <div class = "TableCell">
                            <p id = "fps_lookup" style = "text-align: right"></p>
                        </div>
                </div>
            </div>
            <div class = "Table">
                <div id="torch_selector_container" style = "display : none">
                    <div class = "TableRow">
                        <div class = "TableCell">
                            <p>SPARK THRESHOLD</p>
                        </div>
                        <div class = "TableCell">
                            <p><input type="range" min="0" max="32" value="0" id="torch_spark_threshold_slider"></p>
                        </div>
                        <div class = "TableCell">
                            <p id = "torch_spark_threshold_lookup" style = "text-align: right"></p>
                        </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell">
                            <p>PASSIVE RETENTION</p>
                        </div>
                        <div class = "TableCell">
                            <p><input type="range" min="0" max="180" value="0" id="torch_passive_retention_slider"></p>
                        </div>
                        <div class = "TableCell">
                            <p id = "torch_passive_retention_lookup" style = "text-align: right"></p>
                        </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell">
                            <p>H ADJ LEAKAGE</p>
                        </div>
                        <div class = "TableCell">
                            <p><input type="range" min="0" max="100" value="0" id="torch_adj_h_slider"></p>
                        </div>
                        <div class = "TableCell">
                            <p id = "torch_adj_h_lookup" style = "text-align: right"></p>
                        </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell">
                            <p>V ADJ LEAKAGE</p>
                        </div>
                        <div class = "TableCell">
                            <p><input type="range" min="0" max="100" value="0" id="torch_adj_v_slider"></p>
                        </div>
                        <div class = "TableCell">
                            <p id = "torch_adj_v_lookup" style = "text-align: right"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id = "rgb_selector_container" style = "display : none">
                <div class = "Table">
                    <div class = "TableRow">
                        <div class = "TableCell">
                            <p>R</p>
                            <p>G</p>
                            <p>B</p>
                        </div>
                        <div class = "TableCell">
                            <p><input type="range" min="0" max="255" value="0" id="slider_r"></p>
                            <p><input type="range" min="0" max="255" value="0" id="slider_g"></p>
                            <p><input type="range" min="0" max="255" value="0" id="slider_b"></p>
                        </div>
                        <div class = "TableCell">
                            <canvas id="rgb_canvas" width=100% style="border:1px solid rgb(0,0,0)"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

<script src="lib/socket.io.js"></script>

<script>
    const SOCKET_IO_ENDPOINT = "http://localhost:8090";
    let data =
    [
        {
            "name" : "A",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "torch_spark_threshold" : 4,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "R" : 0, "G" : 0, "B" : 0
        },
        {
            "name" : "B",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "torch_spark_threshold" : 4,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "R" : 0, "G" : 0, "B" : 0
        },
        {
            "name" : "C",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "torch_spark_threshold" : 4,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "R" : 0, "G" : 0, "B" : 0
        }
    ];

    /* whenever Icon is clicked dataIdx is set to valid index into data array */
    let dataIdx = -1;

    function hideOtherIcons(idx)
    {
        for(let i = 0; i < data.length; ++i)
        {
            if(idx != i)
            {
                let otherIcon = document.getElementById("icon" + data[i].name);
                otherIcon.style.display = "none";
            }
        }
    }

    function showOtherIcons(idx)
    {
        for(let i = 0; i < data.length; ++i)
        {
            if(idx != i)
            {
                let otherIcon = document.getElementById("icon" + data[i].name);
                otherIcon.style.display = "inline-block";
            }
        }
    }

    function registerIconOnClick()
    {
        for(let i = 0; i < data.length; ++i)
        {
            let icon = document.getElementById("icon" + data[i].name);

            icon.dataIdx = i;
            icon.onclick =
                function()
                {
                    let container = document.getElementById("mode_selector_container");

                    if("none" === container.style.display)
                    {
                        dataIdx =  this.dataIdx;
                        hideOtherIcons(this.dataIdx);
                        updateModeSelector(this.dataIdx);
                        container.style.display = "block";
                    }
                    else
                    {
                        container.style.display = "none";
                        showOtherIcons(this.dataIdx);
                        dataIdx = -1;
                    }
                }
        }
    }

    function updateCanvas(idx)
    {
        let canvas = document.getElementById("rgb_canvas");
        canvas.getContext("2d").fillStyle = "rgb(" + data[idx].R + ", " + data[idx].G + ", " + data[idx].B +")";
        canvas.getContext("2d").fillRect(0, 0, canvas.width, canvas.height);
    }

    function updateSliders(idx)
    {
        let rSlider = document.getElementById("slider_r");
        let gSlider = document.getElementById("slider_g");
        let bSlider = document.getElementById("slider_b");

        rSlider.valueAsNumber = data[idx].R;
        gSlider.valueAsNumber = data[idx].G;
        bSlider.valueAsNumber = data[idx].B;
    }

    function updateModeSelector(idx)
    {
        let selector = document.getElementById("mode_selector");

        if(selector.value !== data[idx].mode)
        {
            selector.value = data[idx].mode;
        }

        {
            let container = document.getElementById("mode_container");
            let brightnessSlider = document.getElementById("brightness_slider");
            let fpsSlider = document.getElementById("fps_slider");
            let sparkThreshold = document.getElementById("torch_spark_threshold_slider");
            let passiveRetention = document.getElementById("torch_passive_retention_slider");
            let adjH = document.getElementById("torch_adj_h_slider");
            let adjV = document.getElementById("torch_adj_v_slider");

            if(
                "solid_rgb" === data[idx].mode
                || "fx_fire" == data[idx].mode
                || "fx_torch" == data[idx].mode)
            {
                brightnessSlider.valueAsNumber = data[idx].brightness;
                document.getElementById("brightness_lookup").innerHTML = data[idx].brightness;
                fpsSlider.valueAsNumber = data[idx].fps;
                document.getElementById("fps_lookup").innerHTML = data[idx].fps;
                sparkThreshold.valueAsNumber = data[idx].torch_spark_threshold;
                document.getElementById("torch_spark_threshold_lookup").innerHTML = data[idx].torch_spark_threshold;
                passiveRetention.valueAsNumber = data[idx].torch_passive_retention;
                document.getElementById("torch_passive_retention_lookup").innerHTML = data[idx].torch_passive_retention;
                adjH.valueAsNumber = data[idx].torch_adj_h;
                document.getElementById("torch_adj_h_lookup").innerHTML = data[idx].torch_adj_h;
                adjV.valueAsNumber = data[idx].torch_adj_v;
                document.getElementById("torch_adj_v_lookup").innerHTML = data[idx].torch_adj_v;
                container.style.display = "block";
            }
            else
            {
                container.style.display = "none";
            }
        }

        /* solid_rgb */
        {
            let container = document.getElementById("rgb_selector_container");


            if("solid_rgb" === data[idx].mode)
            {
                container.style.display = "block";
                updateCanvas(idx);
                updateSliders(idx);
            }
            else
            {
                container.style.display = "none";
            }
        }

        /* fx_torch */
        {
            let container = document.getElementById("torch_selector_container");

            if("fx_torch" === data[idx].mode)
            {
                container.style.display = "block";
                updateCanvas(idx);
                updateSliders(idx);
            }
            else
            {
                container.style.display = "none";
            }
        }
    }

    function emitLampUpdate(idx)
    {
        let socket_io = io(SOCKET_IO_ENDPOINT);

        let request =
            {
                "id" : data[idx].name,
                "mode" : data[idx].mode,
                "brightness" : data[idx].brightness,
                "fps" : data[idx].fps
            };

        if("solid_rgb" === data[idx].mode)
        {
            request.RGB = [data[idx].R, data[idx].G, data[idx].B];
        }
        else if("fx_torch" === data[idx].mode)
        {
            request.torch_spark_threshold = data[idx].torch_spark_threshold;
            request.torch_passive_retention = data[idx].torch_passive_retention;
            request.torch_adj_h = data[idx].torch_adj_h;
            request.torch_adj_v = data[idx].torch_adj_v;
        }

        socket_io.emit("UpdateLamp", request);
    }

    function registerSlidersOnChange()
    {
        let rSlider = document.getElementById("slider_r");
        let gSlider = document.getElementById("slider_g");
        let bSlider = document.getElementById("slider_b");
        let brightnessSlider = document.getElementById("brightness_slider");
        let fpsSlider = document.getElementById("fps_slider");
        let sparkThreshold = document.getElementById("torch_spark_threshold_slider");
        let passiveRetention = document.getElementById("torch_passive_retention_slider");
        let adjH = document.getElementById("torch_adj_h_slider");
        let adjV = document.getElementById("torch_adj_v_slider");

        rSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].R = this.valueAsNumber;
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });

        gSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].G = this.valueAsNumber;
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });

        bSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].B = this.valueAsNumber;
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });
        brightnessSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].brightness = this.valueAsNumber;
                document.getElementById("brightness_lookup").innerHTML = data[dataIdx].brightness;
                emitLampUpdate(dataIdx);
            });
        fpsSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].fps = this.valueAsNumber;
                document.getElementById("fps_lookup").innerHTML = data[dataIdx].fps;
                emitLampUpdate(dataIdx);
            });
        sparkThreshold.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_spark_threshold = this.valueAsNumber;
                document.getElementById("torch_spark_threshold_lookup").innerHTML = data[dataIdx].torch_spark_threshold;
                emitLampUpdate(dataIdx);
            });
        passiveRetention.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_passive_retention = this.valueAsNumber;
                document.getElementById("torch_passive_retention_lookup").innerHTML = data[dataIdx].torch_passive_retention;
                emitLampUpdate(dataIdx);
            });
        adjH.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_adj_h = this.valueAsNumber;
                document.getElementById("torch_adj_h_lookup").innerHTML = data[dataIdx].torch_adj_h;
                emitLampUpdate(dataIdx);
            });
        adjV.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_adj_v = this.valueAsNumber;
                document.getElementById("torch_adj_v_lookup").innerHTML = data[dataIdx].torch_adj_v;
                emitLampUpdate(dataIdx);
            });
    }

    function registerModeSelectorOnChange()
    {
        let modeSelector = document.getElementById("mode_selector");

        modeSelector.onchange =
            function()
            {
                data[dataIdx].mode = this.value;
                updateModeSelector(dataIdx);
                emitLampUpdate(dataIdx);
            };
    }

    window.addEventListener(
        "load",
        function()
        {
            registerIconOnClick();
            registerModeSelectorOnChange();
            registerSlidersOnChange();
        });
</script>
</body>
</html>
