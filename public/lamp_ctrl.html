<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    <link rel="stylesheet" type"text/css" href="./lamp_ctrl.css">
</head>

<body>
    <div>
        <div class = "Table">
            <div class = "TableRow">
                <div class = "TableCell"> <div class ="Icon" id = "iconA"> <img src = "icon/svg/bulb.svg"> A </div> </div>
                <div class = "TableCell"> <div class ="Icon" id = "iconB"> <img src = "icon/svg/bulb.svg"> B </div> </div>
                <div class = "TableCell"> <div class ="Icon" id = "iconC"> <img src = "icon/svg/bulb.svg"> C </div> </div>
                <div class = "TableCell"> <div class ="Icon" id = "iconD"> <img src = "icon/svg/bulb.svg"> D </div> </div>
                <div class = "TableCell"> <div class ="Icon" id = "iconE"> <img src = "icon/svg/bulb.svg"> E </div> </div>
                <div class = "TableCell"> <div class ="Icon" id = "iconF"> <img src = "icon/svg/bulb.svg"> F </div> </div>
                <div class = "TableCell"> <div class ="Icon" id = "iconG"> <img src = "icon/svg/bulb.svg"> G </div> </div>
            </div>
        </div>
    </div>

    <div id="mode_selector_container" style = "display : none">

        <select id="mode_selector">
            <option value="" selected disabled hidden>Choose mode</option>
            <option value="off">OFF</option>
            <option value="solid_rgb">RGB</option>
            <option value="fx_fire">fire</option>
            <option value="fx_torch">torch</option>
            <option value="fx_noise">noise</option>
        </select>

        <div id = "mode_container" style = "display : none">

            <div class = "Table">
                <div class = "TableRow">
                        <div class = "TableCell"> <p>BRIGHTNESS</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="0" max="255" value="0" id="brightness_slider"></p> </div>
                        <div class = "TableCell"> <p id = "brightness_lookup" style = "text-align: right"></p> </div>
                </div>
                <div class = "TableRow">
                    <div class = "TableCell"> <p>REFRESH RATE</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="4" max="60" value="0" id="fps_slider"></p> </div>
                        <div class = "TableCell"> <p id = "fps_lookup" style = "text-align: right"></p> </div>
                </div>
                <div class = "TableRow">
                    <div class = "TableCell">
                        <select id="palette_selector">
                            <option value=255 selected>palette disabled</option>
                            <option value=0>HEAT</option>
                            <option value=1>LAVAL</option>
                            <option value=2>BHW1_SUNSET2</option>
                            <option value=3>BHW2_WHOOO</option>
                            <option value=4>BHW2_47</option>
                            <option value=5>BHW2_G5R</option>
                            <option value=6>BHW3_07</option>
                            <option value=7>BHW3_30</option>
                            <option value=8>BHW4_028</option>
                            <option value=9>BHW4_062</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="torch_selector_container" style = "display : none">
                <div class = "Table">
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>SPARK THRESHOLD</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="0" max="32" value="0" id="torch_spark_threshold_slider"></p> </div>
                        <div class = "TableCell"> <p id = "torch_spark_threshold_lookup" style = "text-align: right"></p> </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>SPARK RETENSION</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="0" max="255" value="0" id="torch_spark_retention_slider"></p> </div>
                        <div class = "TableCell"> <p id = "torch_spark_retention_lookup" style = "text-align: right"></p> </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>SPARK TRANSFER</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="0" max="255" value="0" id="torch_spark_transfer_slider"></p> </div>
                        <div class = "TableCell"> <p id = "torch_spark_transfer_lookup" style = "text-align: right"></p> </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>PASSIVE RETENTION</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="0" max="180" value="0" id="torch_passive_retention_slider"></p> </div>
                        <div class = "TableCell"> <p id = "torch_passive_retention_lookup" style = "text-align: right"></p> </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>H ADJ LEAKAGE</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="0" max="70" value="0" id="torch_adj_h_slider"></p> </div>
                        <div class = "TableCell"> <p id = "torch_adj_h_lookup" style = "text-align: right"></p> </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>V ADJ LEAKAGE</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="0" max="70" value="0" id="torch_adj_v_slider"></p> </div>
                        <div class = "TableCell"> <p id = "torch_adj_v_lookup" style = "text-align: right"></p> </div>
                    </div>
                </div>
            </div>

            <div id="noise_selector_container" style = "display : none">
                <div class = "Table">
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>STEP</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="1" max="100" value="0" id="noise_speed_step_slider"></p> </div>
                        <div class = "TableCell"> <p id = "noise_speed_step_lookup" style = "text-align: right"></p> </div>
                    </div>
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>SCALE</p> </div>
                        <div class = "TableCell"> <p><input type="number" min="1" max="100" value="0" id="noise_scale_slider"></p> </div>
                        <div class = "TableCell"> <p id = "noise_scale_lookup" style = "text-align: right"></p> </div>
                    </div>
               </div>
            </div>

            <div id = "rgb_selector_container" style = "display : none">
                <div class = "Table">
                    <div class = "TableRow">
                        <div class = "TableCell"> <p>R</p> <p>G</p> <p>B</p> </div>
                        <div class = "TableCell">
                            <p> <input type="number" min="0" max="255" value="0" id="slider_r"> <span id="slider_r_lookup" style = "text-align: right"></span> </p>
                            <p> <input type="number" min="0" max="255" value="0" id="slider_g"> <span id="slider_g_lookup" style = "text-align: right"></span> </p>
                            <p> <input type="number" min="0" max="255" value="0" id="slider_b"> <span id="slider_b_lookup" style = "text-align: right"></span> </p>
                        </div>
                        <div class = "TableCell"> <canvas id="rgb_canvas" width=100% style="border:1px solid rgb(0,0,0)"></canvas> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="lib/socket.io.js"></script>

<script>
    const SOCKET_IO_ENDPOINT = "http://localhost:8090";
    let data =
    [
        {
            "name" : "A",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "palette_id" : 255,
            "torch_spark_threshold" : 4,
            "torch_spark_retention" : 200,
            "torch_spark_transfer" : 40,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "solid_rgb" : [0, 0, 0],
            "fx_torch" : [180, 20, 0],
            "noise_speed_step" : 20,
            "noise_scale" : 30
        },
        {
            "name" : "B",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "palette_id" : 255,
            "torch_spark_threshold" : 4,
            "torch_spark_retention" : 200,
            "torch_spark_transfer" : 40,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "solid_rgb" : [0, 0, 0],
            "fx_torch" : [180, 20, 0],
            "noise_speed_step" : 20,
            "noise_scale" : 30
        },
        {
            "name" : "C",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "palette_id" : 255,
            "torch_spark_threshold" : 4,
            "torch_spark_retention" : 200,
            "torch_spark_transfer" : 40,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "solid_rgb" : [0, 0, 0],
            "fx_torch" : [180, 20, 0],
            "noise_speed_step" : 20,
            "noise_scale" : 30
        },
        {
            "name" : "D",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "palette_id" : 255,
            "torch_spark_threshold" : 4,
            "torch_spark_retention" : 200,
            "torch_spark_transfer" : 40,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "solid_rgb" : [0, 0, 0],
            "fx_torch" : [180, 20, 0],
            "noise_speed_step" : 20,
            "noise_scale" : 30
        },
        {
            "name" : "E",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "palette_id" : 255,
            "torch_spark_threshold" : 4,
            "torch_spark_retention" : 200,
            "torch_spark_transfer" : 40,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "solid_rgb" : [0, 0, 0],
            "fx_torch" : [180, 20, 0],
            "noise_speed_step" : 20,
            "noise_scale" : 30
        },
        {
            "name" : "F",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "palette_id" : 255,
            "torch_spark_threshold" : 4,
            "torch_spark_retention" : 200,
            "torch_spark_transfer" : 40,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "solid_rgb" : [0, 0, 0],
            "fx_torch" : [180, 20, 0],
            "noise_speed_step" : 20,
            "noise_scale" : 30
        },
        {
            "name" : "G",
            "mode" : "",
            "brightness" : 255,
            "fps" : 60,
            "palette_id" : 255,
            "torch_spark_threshold" : 4,
            "torch_spark_retention" : 200,
            "torch_spark_transfer" : 40,
            "torch_passive_retention" : 120,
            "torch_adj_h" : 35,
            "torch_adj_v" : 40,
            "solid_rgb" : [0, 0, 0],
            "fx_torch" : [180, 20, 0],
            "noise_speed_step" : 20,
            "noise_scale" : 30
        }
    ];

    /* whenever Icon is clicked dataIdx is set to valid index into data array */
    let dataIdx = -1;

    function hideOtherIcons(idx)
    {
        for(let i = 0; i < data.length; ++i)
        {
            if(idx != i)
            {
                let otherIcon = document.getElementById("icon" + data[i].name);
                otherIcon.style.display = "none";
            }
        }
    }

    function showOtherIcons(idx)
    {
        for(let i = 0; i < data.length; ++i)
        {
            if(idx != i)
            {
                let otherIcon = document.getElementById("icon" + data[i].name);
                otherIcon.style.display = "inline-block";
            }
        }
    }

    function registerIconOnClick()
    {
        for(let i = 0; i < data.length; ++i)
        {
            let icon = document.getElementById("icon" + data[i].name);

            icon.dataIdx = i;
            icon.onclick =
                function()
                {
                    let container = document.getElementById("mode_selector_container");

                    if("none" === container.style.display)
                    {
                        dataIdx =  this.dataIdx;
                        hideOtherIcons(this.dataIdx);
                        updateModeSelector(this.dataIdx);
                        container.style.display = "block";
                    }
                    else
                    {
                        container.style.display = "none";
                        showOtherIcons(this.dataIdx);
                        dataIdx = -1;
                    }
                }
        }
    }

    function updateCanvas(idx)
    {
        let canvas = document.getElementById("rgb_canvas");
        let rgb = data[idx][data[idx].mode];
        canvas.getContext("2d").fillStyle = "rgb(" + rgb[0] + ", " + rgb[1] + ", " + rgb[2] +")";
        canvas.getContext("2d").fillRect(0, 0, canvas.width, canvas.height);
    }

    function updateSliders(idx)
    {
        let rSlider = document.getElementById("slider_r");
        let gSlider = document.getElementById("slider_g");
        let bSlider = document.getElementById("slider_b");

        let rgb = data[idx][data[idx].mode];
        rSlider.valueAsNumber = rgb[0];
        document.getElementById("slider_r_lookup").innerHTML = rgb[0];
        gSlider.valueAsNumber = rgb[1];
        document.getElementById("slider_g_lookup").innerHTML = rgb[1];
        bSlider.valueAsNumber = rgb[2];
        document.getElementById("slider_b_lookup").innerHTML = rgb[2];
    }

    function updateModeSelector(idx)
    {
        let selector = document.getElementById("mode_selector");

        if(selector.value !== data[idx].mode)
        {
            selector.value = data[idx].mode;
        }

        {
            let container = document.getElementById("mode_container");
            let brightnessSlider = document.getElementById("brightness_slider");
            let fpsSlider = document.getElementById("fps_slider");
            let sparkThreshold = document.getElementById("torch_spark_threshold_slider");
            let sparkRetntion = document.getElementById("torch_spark_retention_slider");
            let sparkTransfer = document.getElementById("torch_spark_transfer_slider");
            let passiveRetention = document.getElementById("torch_passive_retention_slider");
            let adjH = document.getElementById("torch_adj_h_slider");
            let adjV = document.getElementById("torch_adj_v_slider");
            let noiseSpeedStep = document.getElementById("noise_speed_step_slider");
            let noiseScale = document.getElementById("noise_scale_slider");

            if(
                "solid_rgb" === data[idx].mode
                || "fx_fire" == data[idx].mode
                || "fx_torch" == data[idx].mode
                || "fx_noise" == data[idx].mode)
            {
                brightnessSlider.valueAsNumber = data[idx].brightness;
                document.getElementById("brightness_lookup").innerHTML = data[idx].brightness;
                fpsSlider.valueAsNumber = data[idx].fps;
                document.getElementById("fps_lookup").innerHTML = data[idx].fps;
                sparkThreshold.valueAsNumber = data[idx].torch_spark_threshold;
                document.getElementById("torch_spark_threshold_lookup").innerHTML = data[idx].torch_spark_threshold;
                sparkRetntion.valueAsNumber = data[idx].torch_spark_retention;
                document.getElementById("torch_spark_retention_lookup").innerHTML = data[idx].torch_spark_retention;
                sparkTransfer.valueAsNumber = data[idx].torch_spark_transfer;
                document.getElementById("torch_spark_transfer_lookup").innerHTML = data[idx].torch_spark_transfer;
                passiveRetention.valueAsNumber = data[idx].torch_passive_retention;
                document.getElementById("torch_passive_retention_lookup").innerHTML = data[idx].torch_passive_retention;
                adjH.valueAsNumber = data[idx].torch_adj_h;
                document.getElementById("torch_adj_h_lookup").innerHTML = data[idx].torch_adj_h;
                adjV.valueAsNumber = data[idx].torch_adj_v;
                document.getElementById("torch_adj_v_lookup").innerHTML = data[idx].torch_adj_v;
                noiseSpeedStep.valueAsNumber = data[idx].noise_speed_step;
                document.getElementById("noise_speed_step_lookup").innerHTML = data[idx].noise_speed_step;
                noiseScale.valueAsNumber = data[idx].noise_scale;
                document.getElementById("noise_scale_lookup").innerHTML = data[idx].noise_scale;
                container.style.display = "block";
            }
            else
            {
                container.style.display = "none";
            }
        }

        /* RGB selector */
        {
            let container = document.getElementById("rgb_selector_container");


            if("solid_rgb" === data[idx].mode || "fx_torch" == data[idx].mode)
            {
                container.style.display = "block";
                updateCanvas(idx);
                updateSliders(idx);
            }
            else container.style.display = "none";
        }

        /* fx_torch parameters */
        {
            let container = document.getElementById("torch_selector_container");

            if("fx_torch" === data[idx].mode) container.style.display = "block";
            else container.style.display = "none";
        }

        /* fx_noise parametes */
        {
            let container = document.getElementById("noise_selector_container");

            if("fx_noise" === data[idx].mode) container.style.display = "block";
            else container.style.display = "none";
        }
    }

    function emitLampUpdate(idx)
    {
        let socket_io = io(SOCKET_IO_ENDPOINT);

        let request =
            {
                "id" : data[idx].name,
                "mode" : data[idx].mode,
                "brightness" : data[idx].brightness,
                "fps" : data[idx].fps,
                "palette_id" : data[idx].palette_id
            };

        if("solid_rgb" === data[idx].mode)
        {
            request.RGB = data[idx][data[idx].mode];
        }
        else if("fx_torch" === data[idx].mode)
        {
            request.torch_spark_threshold = data[idx].torch_spark_threshold;
            request.torch_passive_retention = data[idx].torch_passive_retention;
            request.torch_spark_retention = data[idx].torch_spark_retention;
            request.torch_spark_transfer = data[idx].torch_spark_transfer;
            request.torch_adj_h = data[idx].torch_adj_h;
            request.torch_adj_v = data[idx].torch_adj_v;
            request.torch_color_coeff = data[idx][data[idx].mode];
        }
        else if("fx_noise" === data[idx].mode)
        {
            request.noise_speed_step = data[idx].noise_speed_step;
            request.noise_scale = data[idx].noise_scale;
        }

        socket_io.emit("UpdateLamp", request);
    }

    function registerSlidersOnChange()
    {
        let rSlider = document.getElementById("slider_r");
        let gSlider = document.getElementById("slider_g");
        let bSlider = document.getElementById("slider_b");
        let brightnessSlider = document.getElementById("brightness_slider");
        let fpsSlider = document.getElementById("fps_slider");
        let sparkThreshold = document.getElementById("torch_spark_threshold_slider");
        let sparkRetntion = document.getElementById("torch_spark_retention_slider");
        let sparkTransfer = document.getElementById("torch_spark_transfer_slider");
        let passiveRetention = document.getElementById("torch_passive_retention_slider");
        let adjH = document.getElementById("torch_adj_h_slider");
        let adjV = document.getElementById("torch_adj_v_slider");
        let noiseSpeedStep = document.getElementById("noise_speed_step_slider");
        let noiseScale = document.getElementById("noise_scale_slider");

        rSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx][data[dataIdx].mode][0] = this.valueAsNumber;
                document.getElementById("slider_r_lookup").innerHTML = data[dataIdx][data[dataIdx].mode][0];
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });

        gSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx][data[dataIdx].mode][1] = this.valueAsNumber;
                document.getElementById("slider_g_lookup").innerHTML = data[dataIdx][data[dataIdx].mode][1];
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });

        bSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx][data[dataIdx].mode][2] = this.valueAsNumber;
                document.getElementById("slider_b_lookup").innerHTML = data[dataIdx][data[dataIdx].mode][2];
                updateCanvas(dataIdx);
                emitLampUpdate(dataIdx);
            });
        brightnessSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].brightness = this.valueAsNumber;
                document.getElementById("brightness_lookup").innerHTML = data[dataIdx].brightness;
                emitLampUpdate(dataIdx);
            });
        fpsSlider.addEventListener(
            "change",
            function()
            {
                data[dataIdx].fps = this.valueAsNumber;
                document.getElementById("fps_lookup").innerHTML = data[dataIdx].fps;
                emitLampUpdate(dataIdx);
            });
        sparkThreshold.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_spark_threshold = this.valueAsNumber;
                document.getElementById("torch_spark_threshold_lookup").innerHTML = data[dataIdx].torch_spark_threshold;
                emitLampUpdate(dataIdx);
            });
        sparkRetntion.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_spark_retention = this.valueAsNumber;
                document.getElementById("torch_spark_retention_lookup").innerHTML = data[dataIdx].torch_spark_retention;
                emitLampUpdate(dataIdx);
            });
        sparkTransfer.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_spark_transfer = this.valueAsNumber;
                document.getElementById("torch_spark_transfer_lookup").innerHTML = data[dataIdx].torch_spark_transfer;
                emitLampUpdate(dataIdx);
            });
        passiveRetention.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_passive_retention = this.valueAsNumber;
                document.getElementById("torch_passive_retention_lookup").innerHTML = data[dataIdx].torch_passive_retention;
                emitLampUpdate(dataIdx);
            });
        adjH.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_adj_h = this.valueAsNumber;
                document.getElementById("torch_adj_h_lookup").innerHTML = data[dataIdx].torch_adj_h;
                emitLampUpdate(dataIdx);
            });
        adjV.addEventListener(
            "change",
            function()
            {
                data[dataIdx].torch_adj_v = this.valueAsNumber;
                document.getElementById("torch_adj_v_lookup").innerHTML = data[dataIdx].torch_adj_v;
                emitLampUpdate(dataIdx);
            });
        noiseSpeedStep.addEventListener(
            "change",
            function()
            {
                data[dataIdx].noise_speed_step = this.valueAsNumber;
                document.getElementById("noise_speed_step_lookup").innerHTML = data[dataIdx].noise_speed_step;
                emitLampUpdate(dataIdx);
            });
        noiseScale.addEventListener(
            "change",
            function()
            {
                data[dataIdx].noise_scale = this.valueAsNumber;
                document.getElementById("noise_scale_lookup").innerHTML = data[dataIdx].noise_scale;
                emitLampUpdate(dataIdx);
            });
    }

    function registerModeSelectorOnChange()
    {
        let modeSelector = document.getElementById("mode_selector");

        modeSelector.onchange =
            function()
            {
                data[dataIdx].mode = this.value;
                updateModeSelector(dataIdx);
                emitLampUpdate(dataIdx);
            };
    }

    function registerPaletteSelectorOnChange()
    {
        let selector = document.getElementById("palette_selector");

        selector.onchange =
            function()
            {
                data[dataIdx].palette_id = Number(this.value);
                emitLampUpdate(dataIdx);
            };
    }

    window.addEventListener(
        "load",
        function()
        {
            registerIconOnClick();
            registerModeSelectorOnChange();
            registerPaletteSelectorOnChange();
            registerSlidersOnChange();
        });
</script>
</body>
</html>
